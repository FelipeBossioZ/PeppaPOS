' UserForm: frmCambiarPassword (VERSIÓN SUPER SEGURA)
Option Explicit

Private Sub UserForm_Initialize()
    Me.Caption = "CAMBIAR CONTRASEÑA - SISTEMA POS"
    ' No necesitamos labels complicados
End Sub

Private Sub btnCancelar_Click()
    Unload Me
End Sub

Private Sub btnCambiar_Click()
    CambiarPassword
End Sub

Sub CambiarPassword()
    On Error GoTo ErrorHandler
    
    Dim usuarioActual As String
    Dim passwordActual As String
    Dim nuevoPassword As String
    Dim confirmarPassword As String
    
    ' OBTENER usuario actual de FORMA SEGURA
    usuarioActual = ObtenerUsuarioSeguro()
    
    If usuarioActual = "" Then
        MsgBox "No se pudo identificar el usuario. Contacte al administrador.", vbExclamation
        Exit Sub
    End If
    
    passwordActual = Me.txtPasswordActual.Text
    nuevoPassword = Me.txtNuevoPassword.Text
    confirmarPassword = Me.txtConfirmarPassword.Text
    
    ' Validaciones
    If passwordActual = "" Or nuevoPassword = "" Or confirmarPassword = "" Then
        MsgBox "Todos los campos son obligatorios", vbExclamation
        Exit Sub
    End If
    
    If nuevoPassword <> confirmarPassword Then
        MsgBox "Las nuevas contraseñas no coinciden", vbExclamation
        Me.txtNuevoPassword.Text = ""
        Me.txtConfirmarPassword.Text = ""
        Me.txtNuevoPassword.SetFocus
        Exit Sub
    End If
    
    If Len(nuevoPassword) < 4 Then
        MsgBox "La nueva contraseña debe tener al menos 4 caracteres", vbExclamation
        Exit Sub
    End If
    
    ' Verificar y cambiar contraseña
    If VerificarYCambiarPassword(usuarioActual, passwordActual, nuevoPassword) Then
        MsgBox "? Contraseña cambiada exitosamente para: " & usuarioActual, vbInformation
        Unload Me
    Else
        MsgBox "? Contraseña actual incorrecta", vbExclamation
        Me.txtPasswordActual.Text = ""
        Me.txtPasswordActual.SetFocus
    End If
    
    Exit Sub
    
ErrorHandler:
    MsgBox "Error al cambiar contraseña: " & Err.Description, vbCritical
End Sub

Function ObtenerUsuarioSeguro() As String
    On Error Resume Next
    
    ' Método 1: Desde Names
    ObtenerUsuarioSeguro = ThisWorkbook.Names("UsuarioActual").RefersToRange.Value
    If ObtenerUsuarioSeguro <> "" Then Exit Function
    
    ' Método 2: Desde registro de Windows
    ObtenerUsuarioSeguro = GetSetting("SistemaPOS", "Login", "Usuario", "")
    If ObtenerUsuarioSeguro <> "" Then Exit Function
    
    ' Método 3: Por defecto según quién podría estar usando
    ObtenerUsuarioSeguro = "admin"
End Function

Function VerificarYCambiarPassword(usuario As String, passwordActual As String, nuevoPassword As String) As Boolean
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("Usuarios")
    
    Dim fila As Long
    For fila = 2 To ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
        If ws.Cells(fila, 2).Value = usuario Then
            ' Verificar contraseña actual
            If ws.Cells(fila, 3).Value = passwordActual Then
                ' Cambiar contraseña
                ws.Cells(fila, 3).Value = nuevoPassword
                VerificarYCambiarPassword = True
                Exit Function
            Else
                VerificarYCambiarPassword = False
                Exit Function
            End If
        End If
    Next fila
    
    VerificarYCambiarPassword = False
    Exit Function
    
ErrorHandler:
    VerificarYCambiarPassword = False
End Function
